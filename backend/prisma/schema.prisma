// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url = env("POSTGRES_URL_ONLINE")
}

enum Role {
  user
  admin
}

enum Size {
  Tiny
  Small
  Medium
  Large
  Huge
  Gargantuan
}

enum Alignment {
  chaotic_good
  chaotic_evil
  chaotic_neutral
  neutral
  lawful_neutral
  lawful_evil
  lawful_good
  neutral_good
  neutral_evil
}

model Users {
  id             String    @id @default(uuid())
  name           String
  email          String    @unique
  passwordHashed String?   // null gdy OAuth
  provider       String    @default("local")
  providerId     String?   @unique

  role           Role @default(user)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  characters     Character[]
  campaigns_owned      Campaign[] @relation(name: "CampaignOwner")
  campaigns_contributed Campaign[] @relation(name: "CampaignContributors")

}


model Character {
  id           String    @id @default(uuid())
  name         String
  ownerId      String
  owner        Users      @relation(fields: [ownerId], references: [id])
  campaignId   String?
  campaign     Campaign? @relation(fields: [campaignId], references: [id])

  raceId       String?
  race         Race?     @relation(fields: [raceId], references: [id])
  subraceId    String?
  subRace     SubRace?  @relation(fields: [subraceId], references: [id])

  classId      String?
  class        Class?    @relation(fields: [classId], references: [id])

  subclassId   String?
  subclass     Subclass? @relation(fields: [subclassId], references: [id])

  level        Int       @default(1)
  xp           Int       @default(0)
  background   String?
  alignment    String?
  size         Size? 
  inspiration  Boolean   @default(false)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  personalityTraits String?
  ideals            String?
  bonds             String?
  flaws             String?

  stats            CharacterStats?
  saves            CharacterSaves?
  skills           CharacterSkill[]
  combat           CharacterCombatStats?
  proficiencies    CharacterProficiency[]
  features         CharacterFeature[]
  inventoryItems   InventoryItem[]
  knownSpells      CharacterKnownSpell[]
  preparedSpells   CharacterPreparedSpell[]
  spellSlots       CharacterSpellSlot[]
  currency         CharacterCurrency?

  characterEventLogs CharacterEventLog[]


}


model CharacterStats {
  characterId String  @id
  character   Character @relation(fields: [characterId], references: [id])

  str Int @default(10)
  dex Int @default(10)
  con Int @default(10)
  int Int @default(10)
  wis Int @default(10)
  cha Int @default(10)
}


model CharacterSaves {
  characterId String  @id
  character   Character @relation(fields: [characterId], references: [id])

  strProficient Boolean @default(false)
  dexProficient Boolean @default(false)
  conProficient Boolean @default(false)
  intProficient Boolean @default(false)
  wisProficient Boolean @default(false)
  chaProficient Boolean @default(false)
}


model CharacterSkill {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  name        String
  proficient  Boolean  @default(false)
  expertise   Boolean  @default(false) // double proficiency
  bonus       Int?     // manual bonus (buffs etc.)
}

model CharacterProficiency {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  type        String   // "weapon" | "armor" | "tool" | "language"
  name        String
}


model CharacterCombatStats {
  characterId     String @id
  character       Character @relation(fields: [characterId], references: [id])

  hp              Int    @default(0)
  hpMax           Int    @default(0)
  ac              Int? 
  initiative      Int?
  speed           Int? 
  hitDiceType     Int?   // e.g. 8 for d8
  hitDiceCurrent  Int?   // remaining hit dice
  hitDiceTotal    Int?   // total hit dice
  deathSavesSuccess Int @default(0)
  deathSavesFail    Int @default(0)
  passivePerception Int?
}

model Item {
  id          String   @id @default(uuid())
  name        String
  type        String    // weapon, armor, gear, consumable...
  description String?
  weight      Float?
  value       Int?      // gp value
  properties  String?   // serialized small flags, or create ItemProperty table later
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  inventoryItems InventoryItem[]
}

model InventoryItem {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  itemId      String
  item        Item     @relation(fields: [itemId], references: [id])

  quantity    Int      @default(1)
  equipped    Boolean  @default(false)
  notes       String?
}


model Spell {
  id          String   @id @default(uuid())
  name        String
  level       Int
  school      String?
  castingTime String?
  range       String?
  components  String?
  duration    String?
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  knownBy     CharacterKnownSpell[]
  preparedBy  CharacterPreparedSpell[]
}

model CharacterKnownSpell {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  spellId     String
  spell       Spell     @relation(fields: [spellId], references: [id])

  learnedAtLevel Int?
}

model CharacterPreparedSpell {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  spellId     String
  spell       Spell     @relation(fields: [spellId], references: [id])

  preparedAt  DateTime @default(now())
}


model CharacterSpellSlot {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  spellLevel  Int    
  maxSlots    Int    @default(0)
  usedSlots   Int    @default(0)
}


model Feature {
  id          String   @id @default(uuid())
  name        String
  description String?
  sourceType  String?
  sourceId    String?

  characterFeatures CharacterFeature[]
}

model CharacterFeature {
  id          String   @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])

  featureId   String
  feature     Feature   @relation(fields: [featureId], references: [id])

  acquiredAtLevel Int?
  notes       String?
}

model Race {
  id        String @id @default(uuid())
  name      String @unique
  description String?
  subRaces  SubRace[]
  size      Size?
  speed     Int?
  languages String?
  raceAbilities RaceAbility[]
  characters Character[]
}

model SubRace {
  id        String @id @default(uuid())
  parentRaceId String
  parentRace Race @relation(fields: [parentRaceId], references: [id])
  name      String @unique
  description String?
  subRaceAbilities SubRaceAbility[]
  characters Character[]
}

model RaceAbility {
  id      String @id @default(uuid())
  raceId  String
  race    Race   @relation(fields: [raceId], references: [id])
  name    String
  description String?
}

model SubRaceAbility {
  id        String @id @default(uuid())
  subRaceId String
  subRace   SubRace @relation(fields: [subRaceId], references: [id])
  name      String
  description String?
}


model Class {
  id        String @id @default(uuid())
  name      String @unique
  hitDie    Int
  spellcasting Boolean @default(false)
  description String?
  subclasses Subclass[]
  progressions ClassProgression[]

  characters Character[]
}

model Subclass {
  id        String @id @default(uuid())
  classId   String
  class     Class  @relation(fields: [classId], references: [id])
  name      String
  description String?

  characters Character[]
}

model ClassProgression {
  id        String @id @default(uuid())
  classId   String
  class     Class  @relation(fields: [classId], references: [id])

  level     Int
  features  String?   // csv of feature ids or JSON string â€” can be normalized later to ClassFeature table
  hpPerLevel Int     // average HP gained per level (or die roll average)
  spellSlots Json?   // optional: canonical slots for that level, keep as JSON for flexibility
}


model CharacterCurrency {
  characterId String @id
  character   Character @relation(fields: [characterId], references: [id])

  gp Int @default(0)
  sp Int @default(0)
  ep Int @default(0)
  cp Int @default(0)
  pp Int @default(0)
}

model Feat {
  id          String @id @default(uuid())
  name        String
  description String?
}


model CharacterEventLog {
  id          String @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id])
  type        String
  payload     Json?
  createdAt   DateTime @default(now())
}

model Campaign {
  id     String @id @default(uuid())
  name   String
  description String
  joinCode String

  owner   Users   @relation(name: "CampaignOwner", fields: [ownerId], references: [id])
  ownerId String

  contributors Users[] @relation(name: "CampaignContributors")
  characters Character[]
  missions Mission[]
  notes Note[]
  maps Map[]
  locations Location[]
  npcs NPC[]
}

enum MissionStatus {
  pending
  in_progress
  completed
}

model Mission {
  id     String @id @default(uuid())
  title  String
  description String
  status MissionStatus

  campaign   Campaign @relation(fields: [campaignId], references: [id])
  campaignId String
}

model Note {
  id     String @id @default(uuid())
  name   String
  description String
  author String
  date   DateTime

  campaign   Campaign @relation(fields: [campaignId], references: [id])
  campaignId String
}

model Map {
  id     String @id @default(uuid())
  file   String
  name   String
  description String

  campaign   Campaign @relation(fields: [campaignId], references: [id])
  campaignId String
}


model Location {
  id     String @id @default(uuid())
  name   String
  description String

  campaign   Campaign @relation(fields: [campaignId], references: [id])
  campaignId String
  npcs NPC[]
}


model NPC {
  id     String @id @default(uuid())
  name   String
  description String

  campaign   Campaign @relation(fields: [campaignId], references: [id])
  campaignId String

  locations Location[]
}



